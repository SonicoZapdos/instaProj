@model instaProj.Models.Post

@{
    ViewData["Title"] = "Post";
}

<div class="maxW d-flex flex-column gap-4" style="height: 100%; overflow: auto;" id="forYou">
    <div class="maxW box-post p-1" id="new-post">
        <div class="col">
            <form asp-action="CreatePost" asp-controller="Posts" enctype="multipart/form-data" method="post"
                  id="postForm">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                <div class="row d-flex align-items-center gap-3 p-2">
                    <div class="logo">
                        <img src="/images/ppic.png" alt="" class="user">
                    </div>
                    <br>
                    <div class="form-floating p-1" style="width:85%">
                        <textarea class="form-control" id="floatingTextarea" maxlength="250" placeholder="Novo Post"
                                  asp-for="Description" style="background-color: lightgrey"></textarea>
                        <label for="floatingTextarea">Novo Post</label>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>
                </div>
                <input type="file" id="inputFile" class="d-none" multiple onchange="handleFileSelect(event)" />

                <!-- Carrossel de Imagens -->
                <div id="carouselExampleControls" class="carousel slide d-none maxW" data-bs-ride="carousel" style="height: 300px">
                    <div class="carousel-inner" id="carouselInner">
                        <!-- Imagens selecionadas aparecerão aqui -->
                    </div>
                    <button class="carousel-control-prev" type="button"
                            data-bs-target="#carouselExampleControls" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button"
                            data-bs-target="#carouselExampleControls" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>

                <div class="row d-flex align-items-center justify-content-between p-2 pt-0 pb-2">
                    <div class="row d-flex gap-1 align-items-center justify-content-start" style="width: 70%">
                        <div class="file-input-container">
                            <label class="btn-icon" for="inputFile">
                                <span class="material-symbols-outlined no-config"
                                      style="width: auto;">upload_file</span>
                            </label>
                        </div>
                        <div class="file-input-container">
                            <label class="btn-icon" for="checkLink">
                                <span class="material-symbols-outlined no-config" style="width: auto;">link</span>
                            </label>
                        </div>
                        <div class="d-none w-auto gap-1" id="linkShow">
                            <div class="form-floating linkA" style="height: 40px">
                                <input type="url" class="form-control p-0" id="linkInput" placeholder="Insira um Link" style="height: 40px">
                                <label class="pt-2" for="linkInput" style="overflow:hidden;">Insira um Link</label>
                            </div>
                            <button type="button" onclick="stringSelect()" class="btn btn-dark">Enviar</button>
                            <div class="form-check d-none">
                                <input class="form-check-input" type="checkbox" value="" id="checkLink" onchange="onOpen()">
                            </div>
                        </div>
                    </div>
                    <div class="file-input-container">
                        <button type="submit" class="btn-icon" style="width: auto">
                            <span class="material-symbols-outlined no-config" style="width: auto;">send</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="maxW d-flex flex-column">
        @if (ViewBag.OtherPosts != null && ViewBag.OtherPosts != new List<Post>())
        {
            foreach (Post p in ViewBag.OtherPosts)
            {
                bool firstRun = true;
                <div class="maxW d-flex flex-column box-post">
                    <div class="maxW d-flex justify-content-between align-items-center pe-4 ps-4">
                        <div class="d-flex gap-3 justify-content-center align-items-center">
                            <div class="user"></div>
                            <h4 class="no-config">@p.User.Name</h4>
                        </div>
                        <span class="material-symbols-outlined" style="height: 20px">
                            more_horiz
                        </span>
                    </div>
                    <hr class="maxW no-config mb-1" />
                    @if (p.Archives != null && p.Archives.Count > 0)
                    {
                        <script>
                            console.log('@p.Archives.Count')
                        </script>
                        string id = "carousel-" + p.Id.ToString();
                        <div id="@id" class="carousel slide maxW" data-bs-ride="carousel" data-bs-interval="false" style="height: 300px;">
                            <div class="carousel-inner">
                                @foreach (Archive x in p.Archives)
                                {
                                    if (firstRun)
                                    {
                                        if (x.Link != "" && x.Link != null)
                                        {
                                            string src = "https://www.youtube.com/embed/" + x.Link;
                                            <div class="carousel-item active">
                                                <div class="d-flex justify-content-center">
                                                    <iframe width="560" height="315" src="@src" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                                                </div>
                                            </div>
                                        }
                                        else if (x.Type != ".mp4")
                                        {
                                            <div class="carousel-item active">
                                                <img src="@x.NameLocal" class="maxW" style="height: 300px" />
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="carousel-item active">
                                                <p>This is Video Local</p>
                                            </div>
                                        }
                                        firstRun = false;
                                    }
                                    else
                                    {
                                        if (x.Link != "" && x.Link != null)
                                        {
                                            string src = "https://www.youtube.com/embed/" + x.Link;
                                            <div class="carousel-item">
                                                <div class="d-flex justify-content-center">
                                                    <iframe width="560" height="315" src="@src" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
                                                </div>
                                            </div>
                                        }
                                        else if (x.Type != ".mp4")
                                        {
                                            <div class="carousel-item">
                                                <img src="@x.NameLocal" class="maxW" style="height: 300px" />
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="carousel-item">
                                                <p>This is Video Local</p>
                                            </div>
                                        }
                                    }
                                }
                            </div>
                            <button class="carousel-control-prev" type="button" data-bs-target="#@id" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button" data-bs-target="#@id" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>
                        </div>
                    }
                    <div class="maxW d-flex justify-content-end align-items-center p-1 ps-3 pe-3 gap-2" style="height: 50px;">
                        @if (p.Rating)
                        {
                            <label class="fav" style="width: 50px;" onclick="favItem('@p.Id')">
                                <input type="checkbox" checked>
                                <svg class="star-regular" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512"><path d="M287.9 0c9.2 0 17.6 5.2 21.6 13.5l68.6 141.3 153.2 22.6c9 1.3 16.5 7.6 19.3 16.3s.5 18.1-5.9 24.5L433.6 328.4l26.2 155.6c1.5 9-2.2 18.1-9.6 23.5s-17.3 6-25.3 1.7l-137-73.2L151 509.1c-8.1 4.3-17.9 3.7-25.3-1.7s-11.2-14.5-9.7-23.5l26.2-155.6L31.1 218.2c-6.5-6.4-8.7-15.9-5.9-24.5s10.3-14.9 19.3-16.3l153.2-22.6L266.3 13.5C270.4 5.2 278.7 0 287.9 0zm0 79L235.4 187.2c-3.5 7.1-10.2 12.1-18.1 13.3L99 217.9 184.9 303c5.5 5.5 8.1 13.3 6.8 21L171.4 443.7l105.2-56.2c7.1-3.8 15.6-3.8 22.6 0l105.2 56.2L384.2 324.1c-1.3-7.7 1.2-15.5 6.8-21l85.9-85.1L358.6 200.5c-7.8-1.2-14.6-6.1-18.1-13.3L287.9 79z"></path></svg>
                                <svg class="star-solid" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512"><path d="M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z"></path></svg>
                            </label>
                        }
                        else
                        {
                            <label class="fav" style="width: 50px;" onclick="favItem('@p.Id')">
                                <input style="z-index: 2" type="checkbox">
                                <svg class="star-regular" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512"><path d="M287.9 0c9.2 0 17.6 5.2 21.6 13.5l68.6 141.3 153.2 22.6c9 1.3 16.5 7.6 19.3 16.3s.5 18.1-5.9 24.5L433.6 328.4l26.2 155.6c1.5 9-2.2 18.1-9.6 23.5s-17.3 6-25.3 1.7l-137-73.2L151 509.1c-8.1 4.3-17.9 3.7-25.3-1.7s-11.2-14.5-9.7-23.5l26.2-155.6L31.1 218.2c-6.5-6.4-8.7-15.9-5.9-24.5s10.3-14.9 19.3-16.3l153.2-22.6L266.3 13.5C270.4 5.2 278.7 0 287.9 0zm0 79L235.4 187.2c-3.5 7.1-10.2 12.1-18.1 13.3L99 217.9 184.9 303c5.5 5.5 8.1 13.3 6.8 21L171.4 443.7l105.2-56.2c7.1-3.8 15.6-3.8 22.6 0l105.2 56.2L384.2 324.1c-1.3-7.7 1.2-15.5 6.8-21l85.9-85.1L358.6 200.5c-7.8-1.2-14.6-6.1-18.1-13.3L287.9 79z"></path></svg>
                                <svg class="star-solid" xmlns="http://www.w3.org/2000/svg" height="1em" viewBox="0 0 576 512"><path d="M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z"></path></svg>
                            </label>
                        }
                        <button type="button" class="btn" data-bs-toggle="modal" data-bs-target="#commentModal">
                            <span class="material-symbols-outlined" style="height: 24px">
                                comment
                            </span>
                        </button>


                    </div>
                    <hr>
                    <div class="maxW ps-3 pe-3">
                        <p class="post_desc">@p.Description</p>
                    </div>
                </div>
                <hr class="maxW hrdiv" />
            }
        }
        else
        {
            <div>
                Não existe postagens ainda!!!
            </div>
        }

    </div>
</div>

<!-- Modais -->
<div class="modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="npm-title">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="npm-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>

<style>
    .border {
        border: 1px solid;
        border-radius: 15px;
        height: 100px;
    }

    #new-post {
        height: auto;
    }

    .box-post {
        background-color: lightgray;
    }

    .file-input-container {
        overflow: hidden;
        border-radius: 50%;
        width: 50px;
        align-items: center;
        height: 50px;
        margin-right: 4px;
        position: relative;
        display: inline-block;
    }

        .file-input-container:hover {
            color: rgb(35, 35, 35);
        }

        .file-input-container input[type="file"] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            cursor: pointer;
        }

    .btn-icon {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 50px;
        height: 50px;
        background-color: transparent;
        border: none;
    }

        .btn-icon:focus {
            outline: none;
        }

        twtaw

    /* Garantir que as imagens do carrossel tenham uma altura de 200px */
    .carousel-inner img {
        height: 200px;
        object-fit: cover;
        /* Manter a proporção da imagem */
    }

    /* Estilizar o botão de remoção ("X") */
    .remove-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2;
    }

        .remove-btn:hover {
            background-color: rgba(255, 0, 0, 0.7);
            color: white;
        }

    /* Reduzir o tamanho dos botões de controle do carrossel */
    .small-carousel-control {
        width: 30px;
        height: 30px;
    }

    .small-carousel-icon {
        width: 20px;
        height: 20px;
    }
</style>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}

<script>
    let selectedFiles = [];

    function handleFileSelect(event) {
        const files = event.target.files;
        for (let i = 0; i < files.length; i++) {
            selectedFiles.push(files[i]);
        }
        displaySelectedFiles();
    }

    function stringSelect() {
        selectedFiles.push(document.getElementById('linkInput').value);
        displaySelectedFiles();
    }

    function displaySelectedFiles() {
        const carouselInner = document.getElementById('carouselInner');
        carouselInner.innerHTML = '';

        selectedFiles.forEach((file, index) => {
            if (typeof file !== 'string') {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const item = document.createElement('div');
                    item.className = 'carousel-item' + (index === 0 ? ' active' : '');
                    item.innerHTML = `
                                                    <img src="${e.target.result}" class="maxW" style="height: 300px" alt="Imagem Selecionada">
                                                        <button type="button" class="remove-btn z-3" onclick="removeFile(${index})"><span class="material-symbols-outlined no-config">
                            close
                            </span></button>
                                                `;
                    carouselInner.appendChild(item);
                    document.getElementById('carouselExampleControls').classList.remove('d-none');
                };
                reader.readAsDataURL(file);
            }
            else {
                const item = document.createElement('div');
                var linkShow = 'http://img.youtube.com/vi/' + file.substring(32) + '/0.jpg';
                item.className = 'carousel-item' + (index === 0 ? ' active' : '');
                item.innerHTML = `
                                                                <img src="${linkShow}" class="maxW" style="height: 300px" alt="Imagem Selecionada">
                                                            <button type="button" class="remove-btn z-3" onclick="removeFile(${index})"><span class="material-symbols-outlined no-config">
                                close
                                </span></button>
                                                    `;
                carouselInner.appendChild(item);
                document.getElementById('carouselExampleControls').classList.remove('d-none');
            }
        });
    }

    function removeFile(index) {
        selectedFiles.splice(index, 1);
        if (selectedFiles.length == 0) {
            document.getElementById('carouselExampleControls').classList.add('d-none');
        }
        displaySelectedFiles();
    }

    document.getElementById('postForm').addEventListener('submit', function (event) {
        event.preventDefault(); // Evitar o envio automático do formulário

        const formData = new FormData(this);
        selectedFiles.forEach((file, index) => {
            if (typeof file !== 'string') {
                formData.append('Archives', file); // Adicionar cada arquivo ao FormData
            }
            else {
                formData.append('Link', file); // Adicionar cada link ao FormData
            }
        });

        fetch('@Url.Action("CreatePost", "Posts")', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRF-TOKEN': $('input[name="__RequestVerificationToken"]').val() // CSRF token
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log('Post enviado com sucesso:', data);
                    window.location.href = data.redirectUrl; // Redireciona para a URL de sucesso
                } else {
                    console.error('Erro ao enviar o post.');
                    window.location.href = data.redirectUrl; // Redireciona para a URL de falha, se desejado
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                // Tratar o erro conforme necessário
            });
    });

    function onOpen() {
        var link = document.getElementById('linkShow');

        if (document.getElementById('checkLink').checked) {
            link.classList.remove('d-none');
            link.classList.add('d-flex');
        }
        else {
            link.classList.add('d-none');
            link.classList.remove('d-flex');
        }
    }
</script>
